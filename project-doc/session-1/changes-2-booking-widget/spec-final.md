# Спецификация: BookingWidget + TWA интеграция + Standalone

**Версия:** final
**Дата:** 2026-02-10

---

## Есть сейчас vs Должно быть

| Аспект | Есть | Должно быть |
|--------|------|-------------|
| Виджет бронирования | Нет | Универсальный Svelte-компонент (TWA + standalone) |
| Бронирование на главной TWA | Нет | Секция бронирования под сторисами |
| Standalone-страница | Нет | Отдельная страница /booking для iframe |
| API-клиент бронирования | Нет | TypeScript модуль для вызовов booking API |

---

## Что на выходе

1. **BookingWidget** — Svelte 5 компонент с 5 шагами бронирования
2. **Интеграция на главную TWA** — виджет под сторисами
3. **Standalone-страница** — `/booking` для iframe-встраивания
4. **API-клиент** — TypeScript модуль для booking endpoints
5. **TypeScript типы** — интерфейсы для booking данных

---

## BookingWidget — универсальный компонент

### Props

```typescript
interface BookingWidgetProps {
  mode: 'twa' | 'standalone';       // режим работы
  telegramUserId?: string;           // из TWA контекста (mode=twa)
  compact?: boolean;                 // компактный вид (опционально)
}
```

### 5 шагов бронирования

**Шаг 1: Выбор даты**
- Календарь текущего месяца с навигацией
- Индикация загруженности дней (зелёный/жёлтый/красный/серый)
- Прошедшие даты неактивны
- Горизонт: сегодня + 90 дней
- API: GET /api/booking/schedule/range

**Шаг 2: Выбор типа и времени**
- Toggle: Взрослые (от 14) / Дети (6-13)
- Сетка слотов с кол-вом свободных мест
- Цвета: зелёный (>50% мест), жёлтый (<=50%), серый (0 мест)
- Смещённые слоты помечены: "+N мин"
- Предупреждение о возможном смещении
- API: GET /api/booking/schedule/:date

**Шаг 3: Детали бронирования**
- Длительность: radio из config.slot_durations (10/15/20 мин)
- Количество участников: counter (1..доступные места)
- Имя (обязательно)
- Телефон (обязательно, маска +7 XXX XXX-XX-XX)
- Email (необязательно)
- Комментарий (textarea, необязательно)
- Чекбокс: правила картинг-центра
- Чекбокс: согласие на возможное смещение
- Расчёт стоимости (обновляется при изменении)
- API: POST /api/booking/calculate-price

**Шаг 4: Подтверждение**
- Сводка: дата, время, тип, участники, длительность, стоимость
- "Оплата на месте"
- Кнопка "Подтвердить бронь"
- API: POST /api/booking/bookings

**Шаг 5: Успех**
- Номер брони
- Дата, время, количество участников
- "Приезжайте за 15 минут для инструктажа"
- "Оплата на месте"
- Кнопка "Вернуться" / "Забронировать ещё"

---

## Дизайн (Dark Racing Theme)

**Цвета (из прототипа S002):**
- Фон: #0a0a0a (основной), #1a1a1a (карточки), #2a2a2a (инпуты)
- Акцент: #ff1744 (красный), #ff4569 (hover)
- Текст: #ffffff (основной), #b0b0b0 (вторичный)
- Зелёный: #4caf50 (доступно)
- Жёлтый: #ff9800 (мало мест)
- Серый: #666666 (недоступно)

**Шрифты:**
- Заголовки: Unbounded
- Текст: Inter

**Стиль:**
- Скруглённые карточки (border-radius: 16px)
- Тени: 0 4px 20px rgba(0,0,0,0.3)
- Анимации переходов между шагами (slide или fade)

**ВАЖНО:** Изучить существующий дизайн TWA перед реализацией. Виджет должен вписываться в общий стиль. Если TWA использует другие цвета/шрифты — адаптировать.

---

## Интеграция на главную TWA

- Найти компонент главной страницы (маршрут `/`)
- Найти блок сторис (stories/highlights)
- Добавить `<BookingWidget mode="twa" telegramUserId={...} />` ПОСЛЕ сторис
- telegram_user_id получить из Telegram WebApp SDK (уже есть в проекте)
- Заголовок секции: "Забронировать заезд" или аналогичный

---

## Standalone-страница

- Маршрут: `/booking` (или `/book`)
- Рендерит `<BookingWidget mode="standalone" />`
- БЕЗ навигации TWA, БЕЗ Telegram SDK зависимости
- Мета-теги: title, description для SEO
- Работает в обычном браузере (desktop + mobile)
- Iframe-ready: проверить X-Frame-Options / CSP headers (разрешить embedding)

---

## Файловая структура (ориентировочная)

```
frontend-sveltekit/src/
├── lib/
│   ├── components/booking/
│   │   ├── BookingWidget.svelte       # Основной компонент (5 шагов)
│   │   ├── BookingCalendar.svelte     # Шаг 1: Календарь
│   │   ├── BookingSlots.svelte        # Шаг 2: Сетка слотов
│   │   ├── BookingDetails.svelte      # Шаг 3: Форма деталей
│   │   ├── BookingConfirm.svelte      # Шаг 4: Подтверждение
│   │   └── BookingSuccess.svelte      # Шаг 5: Успех
│   ├── api/
│   │   └── booking.ts                 # API-клиент
│   └── types/
│       └── booking.ts                 # TypeScript типы
├── routes/
│   ├── +page.svelte                   # Главная (добавить BookingWidget)
│   └── booking/
│       └── +page.svelte               # Standalone-страница
```

> Developer: адаптируй пути под реальную структуру проекта.

---

## Факторы реализации

- **Svelte 5:** Использовать руны ($state, $derived, $effect)
- **Mobile-first:** TWA = мобильное устройство, начинать дизайн с мобильного
- **Telegram WebApp SDK:** Уже подключен в проекте — найти как используется
- **Прототип:** `.apf/.sources/karting-booking/widget/` — НЕ копировать буквально, использовать как визуальный ориентир для dark theme. Переписать на Svelte 5
- **Телефонная маска:** Формат для России (+7 XXX XXX-XX-XX)

---

## Критерии успеха

- [ ] Виджет работает в TWA на главной под сторисами
- [ ] Виджет работает standalone на /booking
- [ ] Полный flow: дата → время → детали → подтверждение → успех
- [ ] Dark racing theme
- [ ] Mobile-first, адаптивность 375px - 1920px
- [ ] Подключён к реальному API (не mock)
- [ ] Валидация форм
- [ ] Loading states
- [ ] Iframe-встраивание работает

## Чек-лист браузера

- [ ] На главной TWA виден блок бронирования под сторисами
- [ ] Календарь: навигация по месяцам, индикация загруженности
- [ ] Слоты: toggle типов, кол-во мест, недоступные серые
- [ ] Форма: валидация обязательных полей, маска телефона
- [ ] Подтверждение: сводка данных, расчёт стоимости
- [ ] Успех: номер брони, инструкции
- [ ] Standalone: полный flow без Telegram
- [ ] Мобильный вид: всё читаемо и кликабельно
