# Спецификация: Admin Management — Таблица бронирований + Ручное создание + Слоты + Настройки

**Версия:** final
**Change:** changes-3-admin-management
**Session:** session-2
**Зависимости:** changes-1-admin-api

---

## Есть сейчас vs Должно быть

| Аспект | Есть | Должно быть |
|--------|------|-------------|
| Список бронирований | Нет | Таблица с фильтрами + действиями |
| Ручное создание | Нет | Быстрая форма для создания по телефону |
| Управление слотами | Нет | Сетка слотов + блокировка/разблокировка |
| Настройки | Нет | Форма настроек booking_config |

---

## Что на выходе

4 интерфейса в разделе "Бронирования" админки:
1. Таблица бронирований (основной рабочий инструмент)
2. Форма ручного создания бронирования
3. Управление слотами (блокировка/разблокировка)
4. Настройки системы бронирования

---

## 1. Таблица бронирований

### Колонки
| Колонка | Описание |
|---------|----------|
| ID | Номер бронирования |
| Время | Дата + время слота |
| Клиент | contact_name + contact_phone |
| Тип | Взрослые / Дети (badge) |
| Участники | Кол-во |
| Сумма | total_price в руб |
| Статус | Цветовой badge (pending/confirmed/cancelled/completed/no_show) |
| Источник | Иконка: TWA (самолётик) / виджет (глобус) / ручная (телефон) |
| Действия | Кнопки подтверждения/отмены/редактирования |

### Цвета статусов
- `pending` — жёлтый
- `confirmed` — зелёный
- `cancelled` — серый
- `completed` — синий
- `no_show` — красный

### Фильтры
- **Дата** — datepicker (по умолчанию = сегодня)
- **Статус** — dropdown (все / pending / confirmed / cancelled / completed / no_show)
- **Тип** — toggle (все / взрослые / дети)
- **Поиск** — текстовое поле (по имени или телефону)

### Действия
- **Подтвердить** (для pending): кнопка -> подтверждение -> статус = confirmed
- **Отменить** (для pending/confirmed): кнопка -> ввод причины -> статус = cancelled
- **Редактировать**: модальное окно с полями брони (admin_notes, participant_count, etc.)

### Mobile (375px)
- Таблица -> карточки бронирований (вертикальные)
- Каждая карточка содержит основную информацию + кнопки действий
- Фильтры сворачиваются в кнопку "Фильтры"

### API
- `GET /api/admin/booking/bookings?date=&status=&search=&page=&limit=`
- `PATCH /api/admin/booking/bookings/:id` (для подтверждения/отмены/редактирования)

---

## 2. Ручное создание бронирования

### Сценарий
Админ принимает звонок от клиента. Клиент на линии ждёт. Нужно быстро:
1. Выбрать дату
2. Выбрать слот (видя свободные места)
3. Ввести имя + телефон
4. Создать бронь

### Форма
- **Модальное окно** или **отдельная секция** (быстрый доступ)
- Поля:
  - Дата (datepicker)
  - Слот (dropdown или grid — из доступных слотов даты)
  - Длительность (10/15/20 мин — из booking_config)
  - Тип (взрослые/дети)
  - Кол-во участников (1-8, ограничено свободными местами)
  - Имя (обязательно)
  - Телефон (обязательно)
  - Заметки (необязательно)
- Кнопка "Создать"

### Логика
- Нет чекбоксов правил (админ знает правила)
- `source = 'admin'`, `created_by_admin_id` из JWT
- После создания: обновить таблицу бронирований, показать уведомление

### Mobile
- Форма удобна на мобильном (сценарий: админ на площадке с телефоном)
- Минимум полей, крупные кнопки

### API
- `POST /api/admin/booking/bookings`

---

## 3. Управление слотами

### Сетка слотов
- Выбор даты -> отображение всех слотов дня
- Каждый слот:
  - Время (HH:MM - HH:MM)
  - Тип (взрослые/дети)
  - Заполненность (N/8)
  - Статус (available/limited/booked/blocked)
  - Кнопка блокировки/разблокировки

### Блокировка слота
- Кнопка "Заблокировать" -> ввод причины -> слот заблокирован
- Заблокированный слот отображается серым с иконкой замка
- Заблокированный слот недоступен для бронирования (клиентский виджет)

### Разблокировка
- Кнопка "Разблокировать" -> слот снова доступен

### Блокировка всего дня
- Кнопка "Закрыть день" -> причина -> все слоты дня заблокированы
- Или: schedule override (is_closed = true)

### Исключение для дня
- Кнопка "Изменить часы" -> ввод custom_open + custom_close -> перегенерация слотов
- Пример: праздник — работаем 09:00-20:00 вместо обычного 11:00-22:00

### API
- `GET /api/admin/booking/slots?date=`
- `POST /api/admin/booking/slots/:id/block`
- `POST /api/admin/booking/slots/:id/unblock`
- `POST /api/admin/booking/schedule/override`

---

## 4. Настройки бронирования

### Поля формы
| Поле | Тип | Описание |
|------|-----|----------|
| Рабочие часы | 7 пар (open/close) | По дням недели |
| Интервал слотов | number (мин) | По умолчанию 15 |
| Буфер | number (мин) | По умолчанию 5 |
| Длительности | multi-select | [10, 15, 20] мин |
| Цены (взрослые) | JSON | {10: 800, 15: 1100, 20: 1400} |
| Цены (дети) | JSON | {10: 600, 15: 850, 20: 1100} |
| Макс. участников | number | По умолчанию 8 |
| Автопилот | toggle | Автоподтверждение броней |
| Горизонт | number (дней) | По умолчанию 90 |

### Логика
- При загрузке: `GET /api/admin/booking/config` -> заполнить форму
- При сохранении: `PATCH /api/admin/booking/config` -> уведомление "Сохранено"
- После сохранения: виджет бронирования отражает новые настройки (без кэша)

### Важно
- Изменение цен сразу влияет на расчёт стоимости в виджете
- Изменение рабочих часов влияет на генерацию новых слотов (не на уже существующие)

### API
- `GET /api/admin/booking/config`
- `PATCH /api/admin/booking/config`

---

## Навигация

Варианты организации:
1. **Вкладки** на странице `/admin/bookings/`: Dashboard | Список | Слоты | Настройки
2. **Подменю** в сайдбаре: Бронирования -> Dashboard / Список / Слоты / Настройки
3. **Всё на одной странице** с разделами

> Developer выбирает оптимальный вариант, согласовав с существующей структурой админки.

---

## Файлы (ориентировочные)

| Файл | Описание |
|------|----------|
| `routes/(admin)/bookings/list/+page.svelte` | Таблица бронирований |
| `routes/(admin)/bookings/slots/+page.svelte` | Управление слотами |
| `routes/(admin)/bookings/settings/+page.svelte` | Настройки |
| `lib/components/admin/booking/BookingsTable.svelte` | Компонент таблицы |
| `lib/components/admin/booking/BookingFilters.svelte` | Фильтры |
| `lib/components/admin/booking/CreateBookingModal.svelte` | Модальное окно создания |
| `lib/components/admin/booking/SlotGrid.svelte` | Сетка слотов |
| `lib/components/admin/booking/BookingSettings.svelte` | Форма настроек |
| `lib/api/admin-booking.ts` | API клиент для admin booking endpoints |

> Пути ориентировочные. Developer адаптирует под реальную структуру.

---

## Факторы реализации

- Использовать существующие паттерны админки (таблицы, фильтры, модальные окна)
- Dark theme — согласовать с существующими стилями
- Mobile: Touch-friendly, крупные кнопки, свайпы для действий
- Пагинация: серверная (через API), не клиентская
- Оптимистичное обновление UI после действий (подтверждение/отмена)

---

## Критерии успеха

- [ ] Таблица бронирований с фильтрами и действиями
- [ ] Ручное создание брони работает (быстрый flow)
- [ ] Блокировка/разблокировка слотов
- [ ] Настройки сохраняются и влияют на виджет
- [ ] Responsive: desktop + mobile (375px)
- [ ] `npm run build` без ошибок

---

## Чек-лист браузера

- [ ] B-001..B-010 (Таблица бронирований)
- [ ] M-001..M-007 (Ручное создание)
- [ ] SL-001..SL-006 (Управление слотами)
- [ ] C-001..C-007 (Настройки)
- [ ] E-002..E-005 (Edge cases)
